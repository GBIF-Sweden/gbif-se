---
layout: default
title: Datasets
permalink: /:basename/
load_tablefilter: true
---

<h1>{{ page.title }}</h1>

<div class="mb-4 text-xl">
  <a href="https://www.gbif.se/ipt/">&raquo; GBIF Sweden IPT</a>
</div>

<div class="mb-4">
  <div>Animalia: <span id="kingdom_1"></span></div>
  <div>Plantae: <span id="kingdom_6"></span></div>
  <div>Fungi: <span id="kingdom_5"></span></div>
  <div>Archaea: <span id="kingdom_2"></span></div>
  <div>Bacteria: <span id="kingdom_3"></span></div>
  <div>Chromista: <span id="kingdom_4"></span></div>
  <div>Protoza: <span id="kingdom_7"></span></div>
  <div>Viruses: <span id="kingdom_8"></span></div>
  <div>Incertae sedis: <span id="kingdom_0"></span></div>
</div>

<table id="datasetstable">
  <thead>
    <tr>
      <th tabindex="0">Title</th>
      <th tabindex="0">Organization</th>
      <th tabindex="0">Type</th>
      <th tabindex="0">Subtype</th>
      <th tabindex="0" data-sort-method="number">Record count</th>
    </tr>
  </thead>
  <tbody>
  </tbody>
</table>

<script type="text/javascript">

  const onPageLoad = async() => {
    // Occurence by kingdom
    const result = await fetch_json('https://api.gbif.org/v1/occurrence/search?publishingCountry=SE&limit=0&facet=kingdomKey');
    const kingdoms = result.facets[0].counts;
    kingdoms.forEach(kingdom => {
      updateElement('kingdom_' + kingdom.name, kingdom.count);
    });

    // Main data table
    records = await fetchRecords();
    populateTable(records);
    setupTableFilter();
  }

  const fetchRecords = async() => {
    const result = await fetch_json('https://api.gbif.org/v1/dataset/search?publishingCountry=SE&limit=500');
    const records = result['results'];

    for (var record of records) {
      await fetchRecordCountIfMissing(record);
    }

    records.sort((a, b) => (a.title > b.title) ? 1 : ((b.title > a.title) ? -1 : 0));

    return records;
  }

  const fetchRecordCountIfMissing = async(record) => {
    if (!'recordCount' in record || record.recordCount == 0 || record.type == 'CHECKLIST') { 
      var count = 0;
      if (record.type == 'OCCURRENCE' || record.type == 'SAMPLING_EVENT') {
        count = await fetch_json('https://api.gbif.org/v1/occurrence/count?datasetKey=' + record.key);
      } else if (record.type == 'CHECKLIST') {
        const result = await fetch_json('https://api.gbif.org/v1/dataset/' + record.key + '/metrics');
        count = result['countByOrigin']['SOURCE'];
      }
      record['recordCount'] = count;
    }
  }

  const populateTable = (records) => {
    const tableBody = document.getElementById('datasetstable').getElementsByTagName('tbody')[0];
    records.forEach(record => {
      const newRow = tableBody.insertRow();
      const tdTitle = document.createElement('td');
      tdTitle.appendChild(Object.assign(document.createElement('a'), 
        {href: 'https://www.gbif.org/dataset/' + record.key, textContent: record.title}));
      newRow.appendChild(tdTitle);
      newRow.appendChild(Object.assign(document.createElement('td'), {textContent: record.publishingOrganizationTitle}));
      newRow.appendChild(Object.assign(document.createElement('td'), {textContent: record.type}));
      newRow.appendChild(Object.assign(document.createElement('td'), {textContent: record.subtype}));
      newRow.appendChild(Object.assign(document.createElement('td'), 
        {className:'table-number text-right', textContent:parseInt(record.recordCount).toLocaleString('en-GB')}));
    });
  }

  const setupTableFilter = () => {
    const tf = new TableFilter('datasetstable', {
      base_path: 'https://unpkg.com/tablefilter@0.7.3/dist/tablefilter/',
      alternate_rows: true,
      col_types: ['string', 'string', 'string', 'string', 'number'],
      col_1: 'select',
      col_2: 'select',
      col_3: 'select',
      col_4: 'none',
      clear_filter_text: '- All -',
      extensions: [{ name: 'sort' }]
    });
    tf.init();
  }

  const fetch_json = async(url) => {
    const response = await fetch(url);
    return await response.json();
  }

  const updateElement = (id, value) => {
    document.getElementById(id).innerText = parseInt(value).toLocaleString('en-GB');
  }

  onPageLoad();

</script>
