---
layout: default
title: Datasets
permalink: /:basename/
load_tablefilter: true
---

<h1>{{ page.title }}</h1>

<article>
  <h2 class="text-lg">Occurrence per kingdom</h2>
  <div class="mb-8 py-2 px-4 shadow-md bg-slate-50 grid grid-cols-2 gap-y-3 sm:grid-cols-3 md:grid-cols-5">
    {% for kingdom in site.data.kingdoms %}
      <div>
        <div class="text-slate-600">{{ kingdom.name }}</div>
        <span class="text-lg">
          {%- for kingdom_count in site.data.kingdom-counts.facets[0].counts -%}
            {%- if kingdom.id == kingdom_count.name -%}
              {%- include functions/number-format.html number=kingdom_count.count ts=',' decimals=0 -%}
            {%- endif -%}
          {%- endfor -%}
        </span>
      </div>
    {% endfor %}
  </div>
</article>

<article>
  <div class="mb-4 text-xl">
    <a href="https://www.gbif.se/ipt/">&raquo; Explore datasets on GBIF Sweden IPT</a>
  </div>
  <div id="tableToolbar" class="max-w-xs sm:max-w-none"></div>
  <table id="datasetstable">
    <thead>
      <tr>
        <th tabindex="0" class="text-left">Title</th>
        <th tabindex="0" class="text-left hidden sm:table-cell">Organization</th>
        <th tabindex="0" class="text-left hidden sm:table-cell">Type</th>
        <th tabindex="0" class="text-left hidden sm:table-cell">Subtype</th>
        <th tabindex="0" class="text-left" data-sort-method="number">Record count</th>
      </tr>
    </thead>
    <tbody>
    </tbody>
  </table>
</article>

<script type="text/javascript">

  const onPageLoad = async() => {
    // Main data table
    records = await fetchRecords();
    populateTable(records);
    setupTableFilter();
  }

  const fetchRecords = async() => {
    const result = await fetch_json('https://api.gbif.org/v1/dataset/search?publishingCountry=SE&limit=500');
    const records = result['results'];

    for (var record of records) {
      await fetchRecordCountIfMissing(record);
    }

    records.sort((a, b) => (a.title > b.title) ? 1 : ((b.title > a.title) ? -1 : 0));

    return records;
  }

  const fetchRecordCountIfMissing = async(record) => {
    if (!'recordCount' in record || record.recordCount == 0 || record.type == 'CHECKLIST') { 
      var count = 0;
      if (record.type == 'OCCURRENCE' || record.type == 'SAMPLING_EVENT') {
        count = await fetch_json('https://api.gbif.org/v1/occurrence/count?datasetKey=' + record.key);
      } else if (record.type == 'CHECKLIST') {
        const result = await fetch_json('https://api.gbif.org/v1/dataset/' + record.key + '/metrics');
        count = result['countByOrigin']['SOURCE'];
      }
      record['recordCount'] = count;
    }
  }

  const populateTable = (records) => {
    const tableBody = document.getElementById('datasetstable').getElementsByTagName('tbody')[0];
    records.forEach(record => {
      const newRow = tableBody.insertRow();
      const tdTitle = document.createElement('td');
      tdTitle.appendChild(Object.assign(document.createElement('a'), 
        {href: 'https://www.gbif.org/dataset/' + record.key, textContent: record.title}));
      newRow.appendChild(tdTitle);
      newRow.appendChild(Object.assign(document.createElement('td'), 
        {className:'hidden sm:table-cell', textContent: record.publishingOrganizationTitle}));
      newRow.appendChild(Object.assign(document.createElement('td'), 
        {className:'hidden sm:table-cell', textContent: record.type}));
      newRow.appendChild(Object.assign(document.createElement('td'), 
        {className:'hidden sm:table-cell', textContent: record.subtype}));
      newRow.appendChild(Object.assign(document.createElement('td'), 
        {className:'table-number text-right', textContent:parseInt(record.recordCount).toLocaleString('en-GB')}));
    });
  }

  const setupTableFilter = () => {
    const tf = new TableFilter('datasetstable', {
      base_path: 'https://unpkg.com/tablefilter@0.7.3/dist/tablefilter/',
      toolbar: {
          target_id: 'tableToolbar'
      },
      alternate_rows: true,
      rows_counter: true,
      paging: {
        length: 25,
      },
      btn_reset: true,
      help_instructions: false,
      filters_row_index: 1,
      col_types: ['string', 'string', 'string', 'string', 'number'],
      col_1: 'select',
      col_2: 'select',
      col_3: 'select',
      col_4: 'none',
      clear_filter_text: '- All -',
      extensions: [{ name: 'sort' }]
    });
    tf.init();

    // Some tweaks to make it look better on mobiles: 
    // - Hide Organization, Type and Subtype columns in the filter rows
    const filterRow = document.getElementsByClassName('fltrow')[0];
    filterRow.children[1].classList.add('hidden');
    filterRow.children[1].classList.add('sm:table-cell');
    filterRow.children[2].classList.add('hidden');
    filterRow.children[2].classList.add('sm:table-cell');
    filterRow.children[3].classList.add('hidden');
    filterRow.children[3].classList.add('sm:table-cell');
    // - Increase the size of mdiv (and decrease rdiv) to make sure paging controls are visible
    document.getElementsByClassName('mdiv')[0].style.width = '58%';
    document.getElementsByClassName('rdiv')[0].style.width = '10%';
  }

  const fetch_json = async(url) => {
    const response = await fetch(url);
    return await response.json();
  }

  onPageLoad();

</script>
